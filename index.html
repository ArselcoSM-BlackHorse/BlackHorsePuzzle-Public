<!DOCTYPE html>
<html lang="en">
  <head>

   <!-- ADD ini di <head> section index.html: -->
<meta name="theme-color" content="#046064">
<meta name="background-color" content="#0891b2">

<!-- PWA meta tags -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Black Horse Puzzle">
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="BlackHorse">

   
<!-- ‚úÖ FAVICONS: yang lama -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
    <title>Black Horse Puzzle</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">
    <link rel="icon" type="image/png" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="shortcut icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
    if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('Service Worker registered ‚úÖ', reg))
        .catch(err => console.log('Service Worker failed ‚õî', err));
      });
    }
   </script>
  
    <style>
     html,body {
        margin: 0;
        padding: 0;
        background: #181c24;
        font-family: 'Segoe UI', 'Arial', sans-serif;
        overflow: auto;
        height: 100%;
      }
      canvas {
        display: block;
         max-width: 100vw;
         max-height: 100vh;
        margin: 0 auto;
      }
    
     #loginBox {
  position: absolute;
  top: 6%;
  left: 88%;
  transform: translate(-50%, -50%);
  background: rgba(30, 34, 44, 0.92);
  border-radius: 12px;
  box-shadow: 0 4px 24px #00eaff40;
  padding: 18px 24px 14px 24px;
  min-width: 340px;
  z-index: 1000;
  display: none;
  text-align: center;
  border: 1.5px solid #00eaff;
  backdrop-filter: blur(6px);
} 
.login-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}
  
#loginBox input[type="text"] {
  width: 200px; /* Lebar input */
  padding: 8px 10px;
  border: 1.2px solid #00eaff;
  border-radius: 7px;
  font-size: 1em;
  background: #23283a;
  color: #fff;
  outline: none;
  box-shadow: 0 0 6px #00eaff40 inset;
  transition: border 0.2s;
}
#loginBox input[type="text"]:focus {
  border: 1.2px solid #fff;
}
#loginBox button {
  background: linear-gradient(90deg, #00eaff 0%, #0078ff 100%);
  color: #fff;
  border: none;
  border-radius: 7px;
  padding: 8px 22px;
  font-size: 1em;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 0 12px #00eaff60;
  letter-spacing: 1px;
  transition: background 0.2s, box-shadow 0.2s;
}
  #loginBox #logoutBtn {
  background: #222;
  color: #fff;
  border: 1px solid #00eaff;
  border-radius: 7px;
  padding: 8px 14px;
  font-size: 0.95em;
  margin-left: 6px;
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
}
#loginBox #logoutBtn:hover {
  background: #00eaff;
  color: #181c24;
}

/* Verification Box mirip Login Box */
#verificationBox {
  position: absolute;
  top: 120px; /* di bawah loginBox */
  left: 50%;
  transform: translate(-50%, 0);
  background: rgba(30, 34, 44, 0.92);
  border-radius: 12px;
  box-shadow: 0 4px 24px #00eaff40;
  padding: 18px 24px 14px 24px;
  min-width: 340px;
  z-index: 1000;
  text-align: center;
  border: 1.5px solid #00eaff;
  backdrop-filter: blur(6px);
  display: none;
}

/* Input kode verifikasi mirip login */
#verificationBox input[type="text"] {
  width: 200px;
  padding: 8px 10px;
  border: 1.2px solid #00eaff;
  border-radius: 7px;
  font-size: 1em;
  background: #23283a;
  color: #fff;
  outline: none;
  box-shadow: 0 0 6px #00eaff40 inset;
  transition: border 0.2s;
}
#verificationBox input[type="text"]:focus {
  border: 1.2px solid #fff;
}

/* Tombol Verify mirip Login */
#verifyBtn {
  background: linear-gradient(90deg, #00eaff 0%, #0078ff 100%);
  color: #fff;
  border: none;
  border-radius: 7px;
  padding: 8px 22px;
  font-size: 1em;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 0 12px #00eaff60;
  letter-spacing: 1px;
  transition: background 0.2s, box-shadow 0.2s;
  margin-left: 10px;
}
#verifyBtn:hover {
  background: linear-gradient(90deg, #0078ff 0%, #00eaff 100%);
  box-shadow: 0 0 18px #00eaffcc;
}

/* Tombol Resend sejajar kanan, di bawah Verify */
#resendVerificationBtn {
  background: linear-gradient(90deg, #00eaff 0%, #0078ff 100%);
  color: #fff;
  border: none;
  border-radius: 7px;
  padding: 8px 22px;
  font-size: 1em;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 0 12px #00eaff60;
  letter-spacing: 1px;
  transition: background 0.2s, box-shadow 0.2s;
  margin-top: 12px;
  float: right;
  margin-right: 0;
}
#resendVerificationBtn:hover {
  background: linear-gradient(90deg, #0078ff 0%, #00eaff 100%);
  box-shadow: 0 0 18px #00eaffcc;
}

#logoutBtn {
  background: #222;
  color: #fff;
  border: 1px solid #00eaff;
  border-radius: 7px;
  padding: 7px 16px;
  font-size: 0.95em;
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
  box-shadow: 0 0 8px #00eaff60;
}
#logoutBtn:hover {
  background: #00eaff;
  color: #181c24;
}

#loginBox button:hover {
  background: linear-gradient(90deg, #0078ff 0%, #00eaff 100%);
  box-shadow: 0 0 18px #00eaffcc;
} 
    </style>
       

<script>
// üîß Service Worker Registration - Seri 1
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then((registration) => {
        console.log('‚úÖ Service Worker registered successfully:', registration.scope);
        
        // Handle updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('üîÑ New Service Worker available - ready to update');
              // Optionally show update notification to user
            }
          });
        });
      })
      .catch((error) => {
        console.warn('‚ö†Ô∏è Service Worker registration failed:', error);
        // Game will work without Service Worker, just no offline support
      });
      
    // Handle Service Worker messages
    navigator.serviceWorker.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'CACHE_UPDATED') {
        console.log('‚úÖ Game assets cached - ready for offline play!');
      }
    });
  });
} else {
  console.log('‚ö†Ô∏è Service Worker not supported in this browser');
}

//======================================================================================
const email = localStorage.getItem("email");
//if (email) {
//  syncProgressFromBackend(email);
//}

// Deklarasi variabel utama
let userData = JSON.parse(localStorage.getItem(`gameData-${email}`)) || {};


// Pastikan gameProgress selalu ada
if (!userData.gameProgress) {
  userData.gameProgress = {
    level01Score: 0,
    // tambahkan field lain jika perlu
  };
}
//======================================================================================

// ‚úÖ DYNAMIC BACKEND URL FUNCTION FOR FRONTEND REPOSITORY
function getBackendUrl() {
  const hostname = window.location.hostname;
  
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    return 'http://localhost:3000'; // Local backend for development
  } else if (hostname.includes('onrender.com') || hostname.includes('arselco.com')) {
    return 'https://backend-paypalblackhorsepuzzle.onrender.com'; // Production backend
  } else {
    return 'https://backend-paypalblackhorsepuzzle.onrender.com'; // Fallback
  }
}

// Fungsi cek status pembayaran dari backend (lengkap)
window.checkPaymentStatusFromBackend = async function(email) {
  try {
    console.log('üîç Checking payment status for:', email);
    //const encodedEmail = encodeURIComponent(email);
    const res = await axios.post(
      `${getBackendUrl()}/api/${encodeURIComponent(email)}/payment-status`,
      { }, // Send email in POST body
      {timeout: 30000}
    );
    const data = res.data;
    console.log('üí≥ Payment status response:', data);

    if (data && data.success) {
      // Kembalikan seluruh data status pembayaran, bukan hanya boolean
      return {
        isPaid: data.isPaid === true,
        supportAmount: data.supportAmount || 0,
        paymentMethods: data.paymentMethods || [],
        gameStats: data.gameStats || {},
        user: data.user || null
      };
    } else {
      console.log('‚ö†Ô∏è Payment check: no success flag in response');
      // Jika respons tidak sesuai harapan
      return {
        isPaid: false,
        supportAmount: 0,
        paymentMethods: [],
        gameStats: {},
        user: null
      };
    }
  } catch (err) {
    console.error('Failed to check payment status:', err);
    // Jika error, kembalikan default unpaid status
    return {
      isPaid: false,
      supportAmount: 0,
      paymentMethods: [],
      gameStats: {},
      user: null
    };
  }
};

//<!-- FIND function checkPaymentStatus around line 350 dan REPLACE dengan: -->
window.checkPaymentStatus = async function(email) {
  let result = { paid: false, method: null };

  try {
    console.log('üí≥ Checking payment status for:', email);
    
    const urlParams = new URLSearchParams(window.location.search);

    //const paymentResult = await checkPaymentStatus(email); // (inputEmail) ganti ke Email
      //  startPaymentMonitoring(email); // (inputEmail) ganti ke Email
      
    // Check Xsolla payment
    if (urlParams.get('paid') === '1') {
      console.log('‚úÖ Payment detected from Xsolla URL parameter');
      if (window.safeUpdatePaymentStatus) {
        safeUpdatePaymentStatus(true, 'xsolla');
      }
      result = { paid: true, method: 'xsolla' };
    } 
    // Check PayPal payment
    else if (urlParams.get('paypal_paid') === '1' || urlParams.get('paypal_success') === 'true') {
      console.log('‚úÖ Payment detected from PayPal URL parameter');
      if (window.safeUpdatePaymentStatus) {
        safeUpdatePaymentStatus(true, 'paypal');
      }
      result = { paid: true, method: 'paypal' };
    }
    // Check PayPal Token 
    else if (urlParams.get('token') && urlParams.get('PayerID')) {
      console.log('‚úÖ PayPal token and PayerID detected');
      if (window.safeUpdatePaymentStatus) {
        safeUpdatePaymentStatus(true, 'paypal');
      }
      result = { paid: true, method: 'paypal' };
    }
  } catch (error) {
    console.error('‚ùå Payment check failed:', error);
    if (window.safeUpdatePaymentStatus) {
      safeUpdatePaymentStatus(false);
    }
    result = { paid: false, method: 'error' };
  }
  
  console.log('üí≥ Payment check result:', result);
  return result;
};
// This function updates the game payment status and UI based on the payment state
// ‚úÖ ENHANCED GAME PAYMENT STATUS UPDATE:

window.updateGamePaymentStatus = function(isPaid, method = null) {
  const email = localStorage.getItem("email");
  if (!email) {
    console.error('‚ùå email not defined in updateGamePaymentStatus');
    return;
  }
  let userData = JSON.parse(localStorage.getItem(`gameData-${email}`)) || {};
  userData.isPaid = isPaid;
  localStorage.setItem(`gameData-${email}`, JSON.stringify(userData));
  window.isPaid = isPaid;
  // Unlock tombol jika sudah bayar
  if (isPaid) {
    if (window.unblur10PuzzleButton) window.unblur10PuzzleButton();
    if (window.unlockGameAfterPurchase) window.unlockGameAfterPurchase();
    console.log('‚úÖ Payment status updated, game unlocked');
  } else {
    if (window.lockAllGameplayButtons) window.lockAllGameplayButtons();
    this.showGameOverReturnMessage && this.showGameOverReturnMessage();
    console.log('üîí Payment not confirmed, game locked');
  }
}

 // Client-side handling of payment status
//if (payment === "cancelled") {
  //console.warn("‚ùå Payment cancelled by user.");
  // (optional) localStorage.setItem('paymentCancelled', 'true');
//}
</script>


  <body>
    <!-- Overlay Landing Warning (muncul sekali per sesi) -->
  <div id="landingOverlay" style="position:absolute;z-index:99999;top:0;left:0;width:100vw;background:#034054;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;overflow-y:auto;min-height:100vh;">
  <div style="position:relative;display:flex;flex-direction:row;align-items:flex-start;justify-content:center;width:100vw;max-width:100vw;margin-top:48px;margin-bottom:0;gap:3vw;min-height:600px;">
        
        <!-- Kiri: Herd (lebih besar, lebih naik) -->
  <img src="BlackHorseHerd.png" alt="Black Horse & Herd" class="responsive-img herd-img">
       
  <!-- Tengah: Banner (lebih lebar dan panjang, font lebih besar) -->
        <div class="banner-container">
          <img src="Black Horse-Please Wait.webp" alt="Black Horse Standing" class="responsive-img banner-img">
          <button id="entranceGameBtn" style="margin:20px auto 24px auto;display:block;background:linear-gradient(90deg,#00eaff 0%,#0078ff 100%);color:#fff;border:none;border-radius:12px;padding:18px 64px;font-size:1.45em;font-weight:700;cursor:pointer;box-shadow:0 0 24px #00eaffcc,0 0 48px #0078ff44 inset;letter-spacing:1.3px;transition:background 0.2s,box-shadow 0.2s;animation:entrance-glow 1.6s infinite alternate;">Entrance ‚Üí Black Horse</button>
          <style>
            @keyframes entrance-glow {
              0% { box-shadow:0 0 24px #00eaffcc,0 0 48px #0078ff44 inset; }
              100% { box-shadow:0 0 48px #00eaff,0 0 64px #0078ff99 inset; }
            }
            #entranceGameBtn:hover {
              background:linear-gradient(90deg,#0078ff 0%,#00eaff 100%);
              box-shadow:0 0 48px #00eaff,0 0 64px #0078ff99 inset;
            }
          </style>
          <h1 style="font-size:2.8em;margin-bottom:0.35em;margin-top:0.2em;color:#00eaff;letter-spacing:1px;text-align:center;font-weight:700;">Official Black Horse Puzzle</h1>
          <div style="color:#ffd600;font-weight:bold;margin:10px 0 10px 0;font-size:1.35em;text-align:center;">Beware of fake or copycat websites!</div>
          <div style="color:#fff;font-size:1.25em;margin-bottom:18px;text-align:center;">
            The <span style="color:#00eaff;font-weight:bold;">arselco.com</span> domain is the ONLY official website for the Black Horse Puzzle Futuristic Game.<br>
            Any other site with a similar name is NOT the original and does NOT represent the true vision of the Black Horse Puzzle creator.
          </div>
          <div style="color:#ffd600;font-weight:bold;margin:8px 0 20px 0;font-size:1.25em;text-align:center;">
            Protect your experience.<br>
            <span style="color:#fff;font-weight:bold;">Play only at <a href="https://arselco.com" style="color:#00eaff;font-weight:bold;text-decoration:underline;">arselco.com</a></span>
          </div>
          <div style="margin-top:30px;font-size:1.15em;color:#b0e0ff;text-align:center;">¬© 2025 Black Horse Puzzle - Futuristic Game by Arselco. All rights reserved.</div>
        </div>

          <!-- Text moved above Entrance button -->
         
       
        <!-- Kanan: Logo Black Horse (kanan atas, sejajar batas atas banner) -->
  <img src="LogoBlackHorse.png" alt="Black Horse Logo" class="responsive-img logo-img">
      </div>
    </div>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow-y: auto !important;
      }
      #landingOverlay {
        overflow-y: auto !important;
        min-height: 100vh;
        box-sizing: border-box;
        padding-bottom: 32px;
      }
      .responsive-img {
        max-width: 100%;
        height: auto;
        display: block;
      }
      .herd-img {
        position: absolute;
        left: 0;
        top: 0;
        width: 18vw;
        min-width: 120px;
        max-width: 320px;
        margin-left: 2vw;
        border-radius: 16px;
        box-shadow: 0 0 32px #00eaff99;
        background: #fff;
        object-fit: contain;
        z-index: 2;
        pointer-events: none;
      }
      .banner-container {
        margin: 0 auto;
        position: relative;
        background: #035154;
        border-radius: 32px;
        padding: 38px 3vw 38px 3vw;
        box-shadow: 0 12px 48px #0008;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-width: 280px;
        max-width: 820px;
        width: 54vw;
        z-index: 1;
        box-sizing: border-box;
      }
      .banner-img {
        width: 32vw;
        min-width: 100px;
        max-width: 220px;
        margin: 0 auto 18px auto;
        display: block;
        filter: drop-shadow(0 0 24px #00eaff80);
      }
      .logo-img {
        position: absolute;
        right: 0;
        top: 0;
        width: 20vw;
        min-width: 80px;
        max-width: 200px;
        margin-right: 2vw;
        border-radius: 20px;
        box-shadow: 0 0 32px #00eaffcc;
        background: #fff;
        border: 3px solid #00eaff;
        object-fit: contain;
        z-index: 3;
        pointer-events: none;
      }
      @media (max-width: 900px) {
        .herd-img { width: 32vw; min-width: 60px; }
        .banner-img { width: 60vw; min-width: 60px; }
        .logo-img { width: 32vw; min-width: 60px; }
        .banner-container { padding: 18px 2vw; max-width: 98vw; }
      }
    </style>
   
   <script>
      // Overlay hanya muncul sekali per sesi browser
      if (window.sessionStorage.getItem('bhpWarningShown')) {
        document.getElementById('landingOverlay').style.display = 'none';
      }
      document.getElementById('entranceGameBtn').onclick = function() {
        document.getElementById('landingOverlay').style.display = 'none';
        window.sessionStorage.setItem('bhpWarningShown', '1');
        // Start SplashScene if Phaser game is ready
        if (window.game && window.game.scene && window.game.scene.isActive) {
          // If SplashScene is not already active, start it
          if (!window.game.scene.isActive('SplashScene')) {
            window.game.scene.start('SplashScene');
          }
        }
      };
    </script>
    <!-- Logo Section (add here if not present) -->
  <!-- Logo section image removed as requested -->
    <!-- Game Container -->
  <div id="game-container"></div>

   <!-- üêé Loading Screen -->
<div id="loader" style="
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: #034054;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  font-family: 'Segoe UI', sans-serif;
  color: #00eaff;
  font-size: 1.2em;
">
  
 <div class="loader-text" >
   <img src="Black Horse-Please Wait.webp" alt="Black Horse" style="height: 250px; margin: 0 auto 16px auto; display: block; filter: drop-shadow(0 0 18px #00eaff80);">
   <div class="loader-wait"></div>
   Please wait... Preparing the BLACK HORSE GAME PUZZLE FUTURISTIC.<br>
   Silahkan tunggu...mempersiapkan Black Horse Game Puzzle Futuristik.<br><br>
  </div>
    <div class="loader-gap"></div>
    <div class="loader-message">
    <span style="color:#fff;">
    Best on desktop or laptop for full experience.<br>
    On Mobile, use the <b>Google</b> browser or "Add to Home Screen" for fullscreen.<br>
    <br>
    Pengalaman terbaik memainkan Game ini di desktop atau laptop.<br> 
    Di ponsel, gunakan browser <b>Google</b> atau "Tambahkan ke Layar Utama" untuk layar penuh.</b>
  </span>
  </div>
  </div>
 
  <!-- ‚úÖ SINGLE LOGOUT BUTTON - PROPER PLACEMENT -->
      <button id="logoutBtn" style="display:none; position: fixed; top: 18px; right: 32px; z-index: 99999;background: #222; color: #fff; border: 1px solid #00eaff; border-radius: 7px; padding: 7px 16px; font-size: 0.95em; cursor: pointer; box-shadow: 0 0 8px #00eaff60; pointer-events: auto;">
      Logout
    </button>
  
    <!-- üêé Login Box -->
     <!-- Login Box: hanya email dan tombol login -->
<div id="loginBox" style="display:block;">
  <div class="login-row">
    <input type="text" id="emailInput" placeholder="Email" autocomplete="off" />
    <button id="loginBtn">Login</button>
  </div>
</div>

<!-- Verification Box: kode verifikasi, tombol verify, dan resend -->
<div id="verificationBox" style="display:none;">
  <div class="login-row">
    <input type="text" id="verificationCodeInput" placeholder="Verification Code" autocomplete="off" />
    <button id="verifyBtn">Verify</button>
  </div>
  <div class="login-row">
    <button id="resendVerificationBtn">Resend Code</button>
  </div>
</div>



<!--
<button id="logoutBtn" style="display:none;">Logout</button>-->
    <!-- === End form login === style="margin-left:10px;" dikeluarkan dari Resend Code === -->

     <!-- Load main.js -->
    <script src="https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/SplashScene.js"></script>
    <script src="https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/Level01Scene.js"></script>
    <script src="https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/Level02Scene.js"></script>
    <script src="./main.js"></script>
    

   <script>
      // Agar mouse wheel di atas canvas tetap scroll halaman, walau canvas diganti/direfresh Phaser
     //Fix Canvas function addScrollToCanvas() {
     window.addScrollToCanvas = function() {
       const canvas = document.querySelector('canvas');
       if (canvas && !canvas._scrollListenerAdded) {
         canvas.addEventListener('wheel', function(e) {
          window.scrollBy(0, e.deltaY);
       });
        canvas._scrollListenerAdded = true;
        console.log('‚úÖ Canvas scroll fixed - no more anvas!');
     }
    } 

// ENHANCED BEACON - Save level01Score dan progress ke backend saat beforeunload
 window.addEventListener('beforeunload', () => {
  const email = localStorage.getItem('email');
  if (!email) return;

  // ‚úÖ AMBIL DATA DARI WINDOW GLOBAL DAN LOCALSTORAGE
  const level01Score = window.level01Score || parseInt(localStorage.getItem(`score_${email}`)) || 0;
  const starAlpha = window.starAlpha || 0;
  const totalPlays = window.totalPlays || 0;
  
  // ‚úÖ AMBIL TIME DARI SCENE INSTANCE JIKA ADA
  let timeElapsed = 0;
  if (window.game && window.game.scene && window.game.scene.getScene) {
    const level01 = window.game.scene.getScene("Level01Scene");
    if (level01 && typeof level01.timeElapsed !== 'undefined') {
      timeElapsed = level01.timeElapsed;
    }
  }

  console.log('üì§ Sending enhanced data via sendBeacon:', {
    level01Score, starAlpha, totalPlays, timeElapsed
  });

  // ‚úÖ ENHANCED PROGRESS DATA WITH DYNAMIC URL
  const progress = {
    email,
    level01Score: level01Score,
    starAlpha: starAlpha,
    totalPlays: totalPlays,
    level01Completed: level01Score > 0,
    completionTime: timeElapsed,
    isPerfectGame: false,
    isGameOver: window.isGameOver || false,
    lossUser: window.lossUser || false,
    gameOverTimestamp: window.isGameOver ? new Date().toISOString() : null,
    saveSource: 'beforeunload_index'
  };

  // ‚úÖ DYNAMIC URL DETECTION FOR FRONTEND REPOSITORY
  const hostname = window.location.hostname;
  let backendUrl = '';
  
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    backendUrl = 'http://localhost:3000'; // Local backend URL for development
  } else if (hostname.includes('onrender.com') || hostname.includes('arselco.com')) {
    backendUrl = 'https://backend-paypalblackhorsepuzzle.onrender.com'; // Production backend URL
  } else {
    backendUrl = 'https://backend-paypalblackhorsepuzzle.onrender.com'; // Fallback
  }

  navigator.sendBeacon(
    `${backendUrl}/api/users/${encodeURIComponent(email)}/update-progress`,
    JSON.stringify(progress)
  );
 });
 
//=================================== BATAS SENDBEACON ====================================

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    const email = localStorage.getItem('email');
    const level01Score = localStorage.getItem(`score_${email}`) || 0;
    // Jika ada timeElapsed yang valid, ambil dari scene, jika tidak, pakai 0
    let time = 0;
    if (window.game && window.game.scene && window.game.scene.getScene) {
      //const level01 = window.game.scene.getScene("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/Level01Scene.js");
      const level01 = window.game.scene.getScene("Level01Scene");
     if (level01 && typeof level01.timeElapsed !== 'undefined') {
        time = level01.timeElapsed;
      }
    }

    console.log('üì§ Visibility hidden - backup level01Score:', level01Score, time);

    if (email) {
      const data = JSON.stringify({
        email,
        level01Completed: false,
        level01Score: level01Score,
        completionTime: time,
        isPerfectGame: false
      });

      //navigator.sendBeacon(
        //'https://backend-paypalblackhorsepuzzle.onrender.com/api/users/' + encodeURIComponent(email) + '/update-progress',
        //new Blob([data], { type: 'text/plain' })
      //);
    }
  }
});
//================================= BATAS VISIBILITY CHANGE =================================
// Definisikan di luar create()
window.initUserData = async function(email, userData = null) {
try {
    console.log(`üîÑ Initializing user data for: ${email}`);
    
    // ‚úÖ 1. SELALU AMBIL DATA TERBARU DARI BACKEND DULU
    const progressRes = await this.getUserProgress(email);
    
    if (progressRes && progressRes.success && progressRes.progress) {
      // ‚úÖ 2. UPDATE SEMUA INSTANCE PROPERTIES DARI BACKEND
      const progress = progressRes.progress;
      
      // Update score dan progress dari backend
      this.level01Score = progress.level01Score || 0;
      this.starAlpha = progress.starAlpha || 0;
      this.level01HighScore = progress.level01HighScore || 0;
      this.totalPlays = progress.totalPlays || 0;
      this.bestTime = progress.bestTime || 0;
      this.averageTime = progress.averageTime || 0;
      this.completionRate = progress.completionRate || 0;
      this.perfectGames = progress.perfectGames || false;
      this.totalAttempts = progress.totalAttempts || 0;
      this.completionTime = progress.completionTime || 0;
      this.isPerfectGame = progress.isPerfectGame || false;
      this.level01Completed = progress.level01Completed || false;
    // ‚úÖ 3. UPDATE USER STATUS DARI BACKEND RESPONSE
      this.newUser = progressRes.newUser || false;
      this.winUser = progressRes.winUser || false;
      this.lossUser = progressRes.lossUser || false;
      this.isGameOver = progressRes.isGameOver || this.lossUser;
      
      // ‚úÖ 4. UPDATE WINDOW GLOBAL VARIABLES
      window.level01Score = this.level01Score;
      window.starAlpha = this.starAlpha;

      
      
      // ‚úÖ 5. UPDATE UI JIKA SUDAH ADA
      if (this.scoreText) {
        this.scoreText.setText(this.level01Score.toString().padStart(5, '0'));
      }
      if (this.starBronzeBlackHorse && this.starAlpha > 0) {
        this.starBronzeBlackHorse.setAlpha(this.starAlpha);
      } 
    // ‚úÖ 6. SYNC KE LOCALSTORAGE SEBAGAI BACKUP
      const userData = {
        gameProgress: progress,
        newUser: progressRes.newUser,
        winUser: progressRes.winUser,
        lossUser: progressRes.lossUser,
        isGameOver: progressRes.isGameOver,
        lastSyncFromBackend: new Date().toISOString(),
        backendSyncSuccess: true
      };
      localStorage.setItem(`gameData-${email}`, JSON.stringify(userData));
      
      console.log(`‚úÖ User data initialized from backend:`, {
        level01Score: this.level01Score,
        totalPlays: this.totalPlays,
        newUser: this.newUser,
        winUser: this.winUser,
        lossUser: this.lossUser,
        isGameOver: this.isGameOver
      });
    return {
        success: true,
        source: 'backend',
        progress: progress,
        userStatus: {
          newUser: this.newUser,
          winUser: this.winUser,
          lossUser: this.lossUser,
          isGameOver: this.isGameOver
        }
      };
      
    } else {
      console.warn('‚ùå Backend response invalid, using fallback initialization');
      throw new Error('Backend response invalid');
    }
    
  } catch (error) {
    console.warn('‚ùå Backend initialization failed, using localStorage fallback:', error);
    
    // ‚úÖ 7. FALLBACK KE LOCALSTORAGE + DEFAULT VALUES
    let userData = JSON.parse(localStorage.getItem(`gameData-${email}`)) || {};
    
    if (userData.gameProgress) {
      // Update dari localStorage yang ada
      this.level01Score = userData.gameProgress.level01Score || 0;
      this.starAlpha = userData.gameProgress.starAlpha || 0;
      this.level01HighScore = userData.gameProgress.level01HighScore || 0;
      this.totalPlays = userData.gameProgress.totalPlays || 0;
      
     // Kalkulasi user status dari localStorage (konsisten dengan backend)
      this.newUser = !userData.gameProgress || userData.gameProgress.totalPlays === 0;
      this.winUser = userData.gameProgress && userData.gameProgress.totalPlays >= 1 && (userData.gameProgress.level01Score || 0) > 0;
      this.lossUser = userData.gameProgress && userData.gameProgress.totalPlays >= 3 && (userData.gameProgress.level01Score || 0) === 0;
      this.isGameOver = this.lossUser;
      
      console.log(`üì• User data loaded from localStorage fallback:`, {
        level01Score: this.level01Score,
        totalPlays: this.totalPlays,
        newUser: this.newUser,
        winUser: this.winUser,
        lossUser: this.lossUser
      });
    } else {
      // ‚úÖ 8. DEFAULT INITIALIZATION UNTUK USER BARU
      this.level01Score = 0;
      this.starAlpha = 0;
      this.level01HighScore = 0;
      this.totalPlays = 0;
      this.bestTime = 0;
      this.averageTime = 0;
      this.completionRate = 0;
      this.perfectGames = false;
      this.totalAttempts = 0;
      this.completionTime = 0;
      this.isPerfectGame = false;
      this.level01Completed = false;
      
      // User status untuk user baru
      this.newUser = true;
      this.winUser = false;
      this.lossUser = false;
      this.isGameOver = false;
      
    // ‚úÖ 9. SAVE DEFAULT DATA KE LOCALSTORAGE DAN BACKEND
      userData = {
        gameProgress: {
          level01Completed: false,
          level01Score: 0,
          level01HighScore: 0,
          totalPlays: 0,
          bestTime: 0,
          averageTime: 0,
          completionRate: 0,
          perfectGames: false,
          totalAttempts: 0,
          completionTime: 0,
          isPerfectGame: false,
          starAlpha: 0
        },
        newUser: true,
        winUser: false,
        lossUser: false,
        isGameOver: false,
        initializedFromDefault: true,
        lastSyncFromBackend: new Date().toISOString()
      };
      localStorage.setItem(`gameData-${email}`, JSON.stringify(userData));
      
      // ‚úÖ 10. SYNC DEFAULT DATA KE BACKEND
      try {
        await this.updateUserProgress(email, userData.gameProgress);
        console.log(`‚úÖ Default user data synced to backend for new user: ${email}`);
      } catch (syncError) {
        console.warn('‚ùå Failed to sync default data to backend:', syncError);
      }
      
      console.log(`üÜï New user initialized with default data: ${email}`);
    }
    
    // ‚úÖ 11. UPDATE WINDOW GLOBAL DARI FALLBACK/DEFAULT
    window.level01Score = this.level01Score;
    window.starAlpha = this.starAlpha;
    
    // Update UI jika sudah ada
    if (this.scoreText) {
      this.scoreText.setText(this.level01Score.toString().padStart(5, '0'));
    }
    
    return {
      success: true,
      source: 'fallback',
      progress: userData.gameProgress,
      userStatus: {
        newUser: this.newUser,
        winUser: this.winUser,
        lossUser: this.lossUser,
        isGameOver: this.isGameOver
      }
    };
  }
}

// ========== ENHANCED SECURE LOGIN & PAYMENT SYSTEM ==========
// ‚úÖ GLOBAL VARIABLES:
let loginInProgress = false;
let paymentCheckInterval = null;

// Add scroll functionality to canvas
  window.addScrollToCanvas();

  // ‚úÖ ENHANCED LOGIN BUTTON WITH level01Score MANAGEMENT: WITH LAZY LOAD 
// ‚úÖ ENHANCED LOGIN HANDLER: ------ Mulai login handler ------------------- 
  document.getElementById("loginBtn").onclick = async function(event) {
  event.preventDefault();
  event.stopPropagation();
 
  const inputEmail = document.getElementById('emailInput').value.trim();
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  
  if (!inputEmail) {
    alert("Please enter your email address!");
    loginInProgress = false;
    return;
  }
  if (!emailPattern.test(inputEmail)) {
    alert("Please enter a valid email address!");
    loginInProgress = false;
    return;
  }

  if (loginInProgress) return;
  loginInProgress = true;

  const loginBtn = document.getElementById('loginBtn');
  const originalText = loginBtn.textContent;
  loginBtn.disabled = true;
  loginBtn.textContent = 'Please Wait...';
  loginBtn.style.opacity = '0.6';


 // Register user (di index.html)
async function registerUser(email) { 
    try {
  const response = await axios.post(
    'https://backend-paypalblackhorsepuzzle.onrender.com/api/users/register',
    { email: email.toLowerCase().trim() },
    { timeout: 30000 }
  );
  const data = response.data;
  console.log('‚úÖ Backend email verification successful:', data.message);
  return true;
} catch (error) {
 if (error.response && error.response.data) {
  const errorData = error.response.data;
  console.log('‚ö†Ô∏è Backend responded with error:', errorData.message);

  // If email already exists, that's OK for login
  if (error.response.status === 409 && errorData.message.includes('already exists')) {
    console.log('‚úÖ Email already registered - allowing login');
    return true;
  }

  throw new Error(`Backend error: ${errorData.message}`);
}
// Tambahan error handling
    console.error('‚ùå Backend verification failed:', error.message);
    return false;
}
}  
try {
    // Proses register ke backend
    console.log('Step 1: Registering user...');
    const registered = await registerUser(inputEmail);
    console.log('Step 2: Registered?', registered);
    if (!registered) {
      alert('Failed to register email. Please try again.');
      return;
    }

    //localStorage.setItem("email", inputEmail);
    console.log('üìß Attempting login with email:', inputEmail);
    
    console.log('Step 3: Sending verification email...');
    // Selalu cek ke backend, kirim kode verifikasi ke email
    await window.resendVerificationEmail(inputEmail);
    console.log('Step 4: Showing verification box...');
    // Tampilkan verificationBox, sembunyikan login dan logoutBtn
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("logoutBtn").style.display = "none";
    // Tampilkan verificationBox
    document.getElementById("verificationBox").style.zIndex = "1000";
    document.getElementById("verificationBox").style.display = "block";
    document.getElementById("verificationCodeInput").style.display = "inline-block";
    document.getElementById("verifyBtn").style.display = "inline-block";
    console.log('‚úÖ Verification box displayed');
  } catch (error) {
    if (error.response && error.response.data) {
      const errorData = error.response.data;
    }
   // if (window.hidePleaseWaitMessage) hidePleaseWaitMessage();
   // console.error('‚ùå Login error:', error.message);
   // alert('Login Error: ' + error.message);
     // Sembunyikan verificationBox, tampilkan loginBox
  document.getElementById("verificationBox").style.display = "none";
  document.getElementById("loginBox").style.display = "block";
  } finally {
    setTimeout(() => {
      loginBtn.disabled = false;
      loginBtn.textContent = originalText;
      loginBtn.style.opacity = '1';
      loginInProgress = false;
    }, 800);
  }
  }
// END OF LOGIN HANDLER 
//--------------Batas login handler-------------------
  
// ‚úÖ ENHANCED VERIFICATION HANDLER:
 // Handler tombol Verify
document.getElementById("verifyBtn").onclick = async function() {
  const email = document.getElementById('emailInput').value.trim();
  const code = document.getElementById('verificationCodeInput').value.trim();

  try {
    const response = await axios.post(
      'https://backend-paypalblackhorsepuzzle.onrender.com/api/users/verify-email',
      { email, verificationCode: code },
      { timeout: 30000 }
    );
    const data = response.data;
    console.log('‚úÖ Email verification response:', data);

    //if (data.emailVerified === true) {
    if (data.user && data.user.emailVerified === true) {
      //alert('Email verified successfully! Welcome to Black Horse Puzzle!');
      document.getElementById("verificationCodeInput").value = "";
      localStorage.setItem("email", email);
      document.getElementById("verificationBox").style.display = "none";
      document.getElementById("logoutBtn").style.display = "inline-block";
      document.getElementById("verificationCodeInput").value = "";
      if (window.Phaser && window.game && window.game.scene) {
        //window.game.scene.start("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/SplashScene.js");
        window.game.scene.start("SplashScene");
        console.log('üöÄ Starting SplashScene after verification');
      }
      if (window.showSuccessNotification) {
        showSuccessNotification('‚úÖ Email Verified - Welcome!');
      }
    } else {
      alert('Verification failed: ' + (data.message || 'Please check your email address.'));
    }
  } catch (error) {
    alert('Verification failed: ' + error.message);
  }
}


//  EMAIL VERIFICATION FUNCTIONS:
function verifyEmailFormat(email) {
  const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
  return emailPattern.test(email);
}
// EMERGENCY FIX - PASTE SEKARANG:
console.log('üö® FIXING DUPLICATE FUNCTION - ADDING REAL BACKEND VERIFICATION');
console.log('Username yang dikirim:', this.username);


async function checkEmailVerifiedFromBackend(email) {
  try {
    const response = await axios.post(
      'https://backend-paypalblackhorsepuzzle.onrender.com/api/users/check-email',
      { email: email},
      { timeout: 30000 }
    );
    return response.data && response.data.emailVerified === true;
  } catch (error) {
    return false;
  }
}

//RESEND VERIFICATION BUTTON HANDLER
document.getElementById("resendVerificationBtn").onclick = async function() {
  const email = document.getElementById('emailInput').value.trim();
  if (!email) {
    alert('Please enter your email address!');
    return;
  }
  await window.resendVerificationEmail(email);
};

//  Create missing window.gameUtils
window.gameUtils = {
    validateEmail: function(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
};
    // ‚úÖ ENHANCED EMAIL RESEND VERIFICATION CODE
window.resendVerificationEmail = async function(email) {
  try {
    const response = await axios.post(
      'https://backend-paypalblackhorsepuzzle.onrender.com/api/users/resend-verification',
      { email },
      { timeout: 30000 }
    );
    const data = response.data;
    if (data.success) {
      alert('Verification code has been sent to your email. Please check your inbox or spam.');
      console.log('‚úÖ Resend verification success:', email);
      return true;
    } else {
      alert('Failed to resend verification code. Please try again later.');
      console.warn('‚ùå Resend verification failed:', data.message || 'Unknown error');
      return false;
    }
  } catch (error) {
    console.error('‚ùå Error resend verification:', error.message);
    alert('An error occurred while resending the code. Please try again later.');
    return false;
  }
};

//  Create proper showMessage function
window.showMessage = function(message, color = '#ff6b6b') {
    alert(message);
    console.log('üì¢ Message:', message);
};   


// Redefine verifyEmailWithBackend with actual backend connection
//async function verifyEmailWithBackend(email) {
window.verifyEmailWithBackend = async function(email) {
  try {
    console.log('üìß Verifying email with backend:', email);

    // Step 1: Local format validation first
    //const isValid = verifyEmailFormat(email);
    const isValidFormat = verifyEmailFormat(email);
    if (!isValidFormat) {
      console.log('‚ùå Invalid email format');
      return false;
    }   
 
    // Step 2: Backend verification
    console.log('üîó Attempting backend connection...');
    const result = await registerUser(email);
    if (result) {
      return true;
    }

     // Fallback jika backend gagal
    return false;
    } catch (error) {
    // Enhanced error handling with fallback
    if (error.name === 'AbortError') {
      console.log('‚è∞ Backend timeout - using fallback validation');
    } else if (error.message.includes('Failed to Axios request')) {
      console.log('üåê Network error - using fallback validation');
    } else if (error.message.includes('CORS')) {
      console.log('üîí CORS error - using fallback validation');
    }
    // FALLBACK: If backend fails but email format is valid, allow login
    const isValidFormat = verifyEmailFormat(email);
    if (isValidFormat) {
      console.log('‚úÖ Using fallback validation - email format valid');
      return true;
    }
    return false;
  }
};


// UNLOCK GLOBAL FUNCTION & HIDE GAME OVER PANEL
window.unlockPlayAndHideGameOver = function() {
if (!window.game || !window.game.scene || !window.game.scene.getScene) {
    console.warn('‚ö†Ô∏è Game not ready for unlockPlayAndHideGameOver');
    return;
  }  
  // Dapatkan scene Level01Scene
  //const level01 = window.game && window.game.scene && window.game.scene.getScene("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/Level01Scene.js");
  const level01 = window.game.scene.getScene("Level01Scene");
  if (!level01) return;

  // Aktifkan tombol Play & 10 Puzzle
  //if (level01.playBtn) {
    //level01.playBtn.setInteractive();
    //level01.playBtn.setAlpha(1);
  //}
  if (level01.lv01Puzzle10Btn) {
    level01.lv01Puzzle10Btn.setInteractive();
    level01.lv01Puzzle10Btn.setAlpha(1);
  }

  // Hilangkan panel Game Over jika ada
  if (level01.gameOverReturnElements) {
    level01.gameOverReturnElements.forEach(el => el && el.destroy());
    level01.gameOverReturnElements = null;
  }
  if (level01.gameOverImg) { //Tidak ada pakai Img lagi
    level01.gameOverImg.destroy();
    level01.gameOverImg = null;
  }

  // Hapus panel konfirmasi pembayaran jika ada (line 3342, 3346)
  if (level01.payPanel) {
    level01.payPanel.destroy();
    level01.payPanel = null;
  }
  if (level01.payText) {
    level01.payText.destroy();
    level01.payText = null;
  }
  if (level01.payQR) {
    level01.payQR.destroy();
    level01.payQR = null;
  }
  if (level01.payBtn) {
    level01.payBtn.destroy();
    level01.payBtn = null;
  }
  if (level01.cancelBtn) {
    level01.cancelBtn.destroy();
    level01.cancelBtn = null;
  }

  // Reset flag Game Over
  level01.isGameOver = false;
  level01.isGameOverClosed = false;

  // (Opsional) Log
  console.log('‚úÖ Game unlocked: Play & Puzzle enabled, Game Over & payment panel hidden');
};


// ‚úÖ ENHANCED REAL BACKEND VERIFICATION READY
console.log('‚úÖ REAL BACKEND VERIFICATION READY - CONNECT TO RENDER.COM');

// ‚úÖ DEFINISI isPaid SEBELUM DIGUNAKAN
async function handleSomeFunction() {
  const email = localStorage.getItem('email');
  if (!email) return;
  
  // ‚úÖ 1. DEFINISI isPaid DARI BACKEND
  const paymentData = await checkPaymentStatusFromBackend(email);
  const isPaid = paymentData && paymentData.isPaid === true;
   
    
   //‚úÖ UPDATE GAME OVER STATE:
    if (isPaid) {
      window.unlockPlayAndHideGameOver();
      //localStorage.setItem(`gameOver_${email}`, 'false');
      localStorage.setItem(`gameOver_${email}`, 'false');
    } else if (lossUser) {
      localStorage.setItem(`gameOver_${email}`, 'true');
    } 
  }
// ‚úÖ ENHANCED level01Score MANAGEMENT FUNCTIONS (ADD FIRST):
// ‚úÖ ENHANCED GET PLAYER GAME level01Score AND HISTORY
function getPlayerGameHistory(email) {
  const history = localStorage.getItem(`gameHistory_${email}`);
  return history ? JSON.parse(history) : {
    hasPlayedBefore: false,
    totalGamesPlayed: 0,
    highestScore: 0,
    gameOvers: 0,
    lastPlayedDate: null,
    favoriteGiven: false
  };
}


// ‚úÖ ENHANCED UPDATE PLAYER GAME level01Score HISTORY
function updatePlayerGameHistory(email, updates) {
  const history = getPlayerGameHistory(email);
  const updatedHistory = { ...history, ...updates };
  localStorage.setItem(`gameHistory_${email}`, JSON.stringify(updatedHistory));
  console.log('üìä Game history updated for:', email, updatedHistory);
  return updatedHistory;
}

// ‚úÖ ENHANCED CHECK PLAYER level01Score STATUS 
function checkPlayerScoreStatus(email) {
  const currentScore = parseInt(localStorage.getItem(`score_${email}`) || 0);
  const history = getPlayerGameHistory(email);
  //localStorage.setItem(`score_${email}`, '0');
  //const currentScore = 0; // Selalu 0, tidak ada angka 3
  
  console.log('üîç Checking level01Score status for:', email);
  console.log('Current level01Score:', currentScore);
  console.log('Game history:', history);
  
  return {
    currentScore: currentScore,
    hasPlayedBefore: history.hasPlayedBefore,
    canPlay: !history.hasPlayedBefore || currentScore > 0, // User baru atau user lama dengan level01Score > 0
    needsFavorite: currentScore === 0 && history.hasPlayedBefore && !history.favoriteGiven,
    isGameOver: currentScore === 0 && history.hasPlayedBefore,
    lockPlay: currentScore === 0 && history.hasPlayedBefore,
    history: history
  };
}

  // Cari posisi logoutBox
  const logoutBox = document.getElementById('logoutBtn');
  const rect = logoutBox ? logoutBox.getBoundingClientRect() : { top: 20, left: window.innerWidth - 180 };

  const warning = document.createElement('div');


// ‚úÖ UTILITY FUNCTIONS:
function showLoginForm() {
  document.getElementById("loginBox").style.display = "block";
  document.getElementById("emailInput").style.display = "inline-block";
  document.getElementById("loginBtn").style.display = "inline-block";
  //document.getElementById("verificationBox").style.display = "block";
  //document.getElementById("verificationCodeInput").style.display = "inline-block";
  //document.getElementById("resendVerificationBtn").style.display = "inline-block";
  document.getElementById("logoutBtn").style.display = "none";
}

//-------------------------------------------------------------------------------------------
// ‚úÖ ENHANCED DOMCONTENTLOADED WITH level01Score MANAGEMENT:
window.addEventListener('DOMContentLoaded', async function() {
  const email = localStorage.getItem("email"); 
   let userData = JSON.parse(localStorage.getItem(`gameData-${email}`)) || {};
 
  console.log('üìÑ Enhanced Black Horse Puzzle - Initializing secure system');
  
  if (email) {
    // ‚úÖ TAMBAH: Auto-sync dengan backend saat page load
    try {
      console.log('üîÑ Starting initial backend sync...');
      const syncResult = await syncProgressFromBackend(email);
      
      if (syncResult.success) {
        console.log('‚úÖ Initial backend sync successful');
        
        // ‚úÖ TAMBAH: Update userData dengan data dari backend
        userData = JSON.parse(localStorage.getItem(`gameData-${email}`)) || {};
        
        // ‚úÖ TAMBAH: Check payment status juga
        const paymentData = await window.checkPaymentStatusFromBackend(email);
        console.log('üí≥ Initial payment check:', paymentData);
        window.updateGamePaymentStatus(paymentData.isPaid, paymentData.method);
        
        // ‚úÖ TAMBAH: Start auto-sync setelah initial sync berhasil
        window.startAutoSync(email);
        
      } else {
        console.log('‚ö†Ô∏è Backend sync failed, using local data');
      }
    } catch (syncError) {
      console.error('‚ùå Initial sync error:', syncError);
    }

    const isValidEmail = verifyEmailFormat(email);
    if (isValidEmail) {
      // ‚úÖ UBAH: Gunakan data yang sudah di-sync dari backend
      const scoreStatus = checkPlayerScoreStatus(email);
      
      // ‚úÖ CHECK PAYMENT STATUS FIRST BEFORE SHOWING WARNING:
      try {
        const paymentData = await window.checkPaymentStatusFromBackend(email);
        console.log('üí≥ Payment status check:', paymentData);
        
        if (paymentData && paymentData.isPaid === true) {
          console.log('‚úÖ Payment detected - user can play normally');
          // Clear game over state
          localStorage.removeItem(`gameOver_${email}`);
          
          // ‚úÖ TAMBAH: Update payment status in userData
          userData.isPaid = true;
          localStorage.setItem(`gameData-${email}`, JSON.stringify(userData));

          // Don't show warning - user already paid
        } else if (scoreStatus.needsFavorite) {
          console.log('‚ö†Ô∏è User needs to give favorite to continue');
          // showGameOverWarning(email); // Only show if no payment
        }
      } catch (error) {
        console.error('‚ùå Payment check error:', error);
        
        // Fallback: show warning only if really needed
        if (scoreStatus.needsFavorite) {
          // showGameOverWarning(email);
        }
      }
      
      console.log('‚úÖ User logged in successfully with enhanced features');
    } else {
      console.log('‚ùå Invalid email format, clearing login');
      //localStorage.removeItem("email");
      showLoginForm();
    }
  } else {
    // Show login form
    document.getElementById("loginBox").style.display = "block";
    document.getElementById("verificationBox").style.display = "none";
    document.getElementById("logoutBtn").style.display = "none";
  }
  // ‚úÖ TAMBAH: Hide loader setelah semua initialization selesai
  const loader = document.getElementById('loader');
  if (loader) {
    setTimeout(() => {
      loader.style.display = 'none';
    }, 1000);
  }

});

// async function handleScoreStatus(inputEmail, scoreStatus) { DIHAPUS KARENA MEMANGGIL UPDATEGAMESCORE YG SUDAH DIHAPUS YG DIPAKAI UPDATEUSERPROGRESS
               
if (window.Phaser && window.game && window.game.scene) {
    //window.game.scene.start("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/SplashScene.js"); //dari Level01Scene ganti ke SplashScene 
    window.game.scene.start("SplashScene");
    // Tambahkan kode ini untuk menyembunyikan level01Score:
      setTimeout(() => {
      //const level01 = window.game?.scene?.getScene("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/Level01Scene.js");
      const level01 = window.game.scene.getScene("Level01Scene");
      if (level01 && level01.scoreText && typeof level01.scoreText.setVisible === 'function') {
        level01.scoreText.setVisible(false);
      }
    }, 1000); // 1 detik setelah scene start 
  
      console.log('‚úÖ Enhanced login complete');
     alert("Login failed. Please try again.");
    }


  // ‚úÖ ENHANCED LOGOUT BUTTON:
  document.getElementById("logoutBtn").onclick = async function() {
    // Hentikan autoSaveInterval jika scene masih aktif (autoSaveInterval ada di Level01Scene line 156)
     const level01 = window.game?.scene?.getScene('Level01Scene');
     if (level01 && level01.autoSaveInterval) clearInterval(level01.autoSaveInterval);

    console.log('üîÑ Starting enhanced logout process...');
    
    const email = localStorage.getItem("email");
    
    stopPaymentMonitoring();
    
    
    //localStorage.removeItem("email");
    document.getElementById("emailInput").value = "";
    document.getElementById("loginBox").style.display = "block";
    document.getElementById("emailInput").style.display = "inline-block";
    document.getElementById("loginBtn").style.display = "inline-block";
    document.getElementById("logoutBtn").style.display = "none";
    
    //if (window.level01Score !== undefined) window.level01Score = 0;
    //window.playerScore = 0;
    
    // Remove any warning dialogs
    const warning = document.getElementById('game-over-warning');
    if (warning) warning.remove();
    const favoriteMenu = document.getElementById('favorite-menu');
    if (favoriteMenu) favoriteMenu.remove();
    
    if (window.showSuccessNotification) {
      showSuccessNotification('üëã Logout successful - Welcome back!');
    }
    
    if (window.Phaser && window.game && window.game.scene) {
      window.game.scene.scenes.forEach(scene => scene.scene.restart());
      
      //const level01 = window.game.scene.getScene("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/Level01Scene.js");
      const level01 = window.game.scene.getScene("Level01Scene");
      if (level01 && level01.playBtn) {
        level01.playBtn.disableInteractive();
        level01.playBtn.setAlpha(0.5);

        const history = getPlayerGameHistory(email);
        const newUser = !history || !history.hasPlayedBefore || (history.totalGamesPlayed || 0) < 3;
        //console.log('INDEX: PlayBtn diaktifkan di sini', { isPaid, newUser });
        const paymentResult = await checkPaymentStatus(email);
        console.log('INDEX: PlayBtn diaktifkan di sini', { isPaid: paymentResult.paid, newUser, });
      }
      
      setTimeout(() => {
        //if (window.Phaser && window.game && window.game.scene) {
        //window.game.scene.start("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/SplashScene.js");
        window.game.scene.start("SplashScene");
      }, 1500);
    }
    
    console.log('‚úÖ Enhanced logout complete');
  };
  
  // ‚úÖ SETUP LOGOUT BUTTON:
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.style.zIndex = '9990';
    logoutBtn.style.position = 'fixed';
    logoutBtn.style.pointerEvents = 'auto';
    logoutBtn.style.top = '18px';
    logoutBtn.style.right = '32px';
    
    const loader = document.getElementById('loader');
    if (loader) {
      loader.style.display = 'none';
    }
    
    const coverBlank = document.getElementById('coverBlank');
    if (coverBlank) {
      coverBlank.style.display = 'none';
    }
    
    console.log('‚úÖ Logout button setup complete');
  }

  //--------------------------------------------------------------------------------------------

    
// ‚úÖ ENHANCED MULTI-PAYMENT VERIFICATION FUNCTIONS:

// 1. CREATE ORDER PAYPAL
async function createPayPalOrder(email, amount, message = 'Black Horse Puzzle Support') {
  try {
    const response = await axios.post(
      'https://backend-paypalblackhorsepuzzle.onrender.com/api/create-order',
      {
        email,
        amount,
        message
      },
      { timeout: 30000 }
    );
    const data = response.data;
    if (data.success && data.paypalOrderId && data.approvalUrl) {
      // Simpan orderId untuk proses selanjutnya
      localStorage.setItem(`paypalOrderId_${email}`, data.paypalOrderId);
      // Redirect user ke PayPal approval
      window.open(data.approvalUrl, '_blank');
      return data.paypalOrderId;
    } else {
      alert('‚ùå Failed to create PayPal order: ' + (data.error || 'Unknown error'));
      return null;
    }
  } catch (error) {
    console.error('‚ùå Error creating PayPal order:', error.message);
    alert('‚ùå Error creating PayPal order: ' + error.message);
    return null;
  }
}

// 2.‚úÖ CAPTURE PEMBAYARAN SETELAH USER APPROVE DI PAYPAL
async function capturePayPalOrder(paypalOrderId, email) {
  try {
    const response = await axios.post(
      `https://backend-paypalblackhorsepuzzle.onrender.com/api/capture-order/${paypalOrderId}`,
      { email },
      { timeout: 30000 }
    );
    const data = response.data;
    if (data.success && data.paypalOrderId === paypalOrderId) {
      // Tandai payment verified di localStorage
      localStorage.setItem(`paymentVerified_${email}`, 'true');
      localStorage.removeItem(`gameOver_${email}`);
      //localStorage.setItem(`score_${email}`, "0");
      // Unlock fitur game jika scene aktif
      if (window.Level01Scene && typeof window.Level01Scene.prototype.unlockGameAfterPurchase === 'function') {
        //const scene = window.game && window.game.scene && window.game.scene.getScene("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/Level01Scene.js");
        const level01 = window.game.scene.getScene("Level01Scene");
        if (scene && typeof scene.unlockGameAfterPurchase === 'function') {
          scene.unlockGameAfterPurchase();
        }
      }
      window.location.href = "/index.html";
      return true;
    } else {
      alert('‚ùå Payment not verified yet.');
      window.location.href = "/payment-error.html";
      return false;
    }
  } catch (error) {
    console.error('‚ùå Error capturing PayPal order:', error.message);
    alert('‚ùå Failed to capture PayPal payment: ' + error.message);
    window.location.href = "/payment-error.html";
    return false;
  }
}

// 6.‚úÖ PAYPAL TOKEN VERIFICATION FUNCTION:
async function verifyPayPalToken(token, payerID, email) {
  try {
    console.log('üÖøÔ∏è Verifying PayPal token:', token);

    // Axios tidak mendukung AbortController langsung, jadi timeout pakai config
    const response = await axios.post(
      'https://backend-paypalblackhorsepuzzle.onrender.com/api/verify-paypal-token',
      { token, payerID, email },
      { timeout: 30000 } // timeout dalam ms
    );

    const data = response.data;
    console.log('üÖøÔ∏è PayPal token verification result:', data);

    return data.verified && data.status === 'APPROVED';

  } catch (error) {
    console.warn('‚ö†Ô∏è PayPal token verification failed:', error.message);
    
    // ‚úÖ FALLBACK - ASSUME VALID IF TOKEN AND PAYER ID EXIST:
    if (token && payerID && token.length > 10 && payerID.length > 10) {
      console.log('üÖøÔ∏è Using fallback verification - token and PayerID look valid');
      return true;
    }
    
    return false;
  }
}

// 5.‚úÖ PAYPAL VERIFICATION FUNCTIONS: Verify Order PayPal
async function verifyPayPalOrder(orderId, email) {
  try {
    console.log('üÖøÔ∏è Verifying PayPal order:', orderId);

    // Axios timeout pakai config
    const response = await axios.post(
      'https://backend-paypalblackhorsepuzzle.onrender.com/api/verify-paypal',
      {paypalOrderId: orderId, email },
      { timeout: 30000 }
    );

    const data = response.data;
    console.log('üÖøÔ∏è PayPal order verification result:', data);

    return data.verified && data.status === 'COMPLETED';

  } catch (error) {
    console.warn('‚ö†Ô∏è PayPal order verification failed:', error.message);
    
    // ‚úÖ FALLBACK - ASSUME VALID IF ORDER ID EXISTS:
    if (orderId && orderId.length > 10) {
      console.log('üÖøÔ∏è Using fallback verification - order ID looks valid');
      return true;
    }
    return false;
  }
}

//------------------------------------------------------------------------------------------------------------
async function startPaymentMonitoring(email) {
  // Monitor payment status every minute
  if (paymentCheckInterval) {
    clearInterval(paymentCheckInterval);
  }
  
  paymentCheckInterval = setInterval(async () => {
    try {
      //checkPaymentStatus(email);
      const result = await checkPaymentStatus(email);
      const paymentData = await window.checkPaymentStatusFromBackend(email);
      window.updateGamePaymentStatus(paymentData.isPaid, paymentData.method);
     } catch (monitoringError) {
      console.error('‚ùå Payment monitoring error:', monitoringError);
     // ‚úÖ SHOW ERROR NOTIFICATION: ----muncul error di F12
     if (window.showErrorNotification) {
     showErrorNotification('‚ùå Payment monitor error: ' + monitoringError.message);
  }
 }
 }, 3000); // Check every minute
   console.log('üîÑ Payment monitoring started for:', email);
}
  
 // ADD ini setelah DOM ready event handler (around line 709):

async function performSecureLogout() {
  const email = localStorage.getItem('email');
  let winUser = false;
 if (email && localStorage.getItem(`gameData-${email}`)) {
    const gameData = JSON.parse(localStorage.getItem(`gameData-${email}`));
    winUser = gameData.gameProgress?.level01Completed === true;
  }

  try {
    console.log('üîÑ Starting secure logout...');
    
    // Stop payment monitoring
    stopPaymentMonitoring();
    
    // Complete data cleanup
    localStorage.removeItem('email');
    if (email) {
      localStorage.removeItem(`gameOver_${email}`);
      localStorage.removeItem(`welcomeBackShown`);
      localStorage.removeItem(`hasClaimedHat`);
    }
    // Reset global scores
    //if (!winUser) {
    //if (window.level01Score !== undefined) window.level01Score = 0;
    //window.playerScore = 0;
    //}
    
    // Clear form
    document.getElementById("emailInput").value = "";
    
    // Show login form
    showLoginForm();
    
    // ‚úÖ ENHANCED LOGOUT - BACK TO SPLASHSCENE:
    if (window.Phaser && window.game && window.game.scene) {
      console.log('üéÆ Stopping all game scenes...');
      
      // Stop all active scenes
      window.game.scene.scenes.forEach(scene => {
        if (scene.scene && scene.scene.isActive()) {
          scene.scene.stop();
        }
      });
      
      // Disable play button
      //const level01 = window.game.scene.getScene("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/Level01Scene.js");
      const level01 = window.game.scene.getScene("Level01Scene");
      if (level01 && level01.playBtn) {
        level01.playBtn.disableInteractive();
        level01.playBtn.setAlpha(0.5);
        console.log('INDEX: PlayBtn diaktifkan di sini', { isPaid, newUser });
      }
      
      // Disable login button temporarily
      document.getElementById("loginBtn").disabled = true;
      
      // Return to SplashScene
      setTimeout(() => {
        //window.game.scene.start("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/SplashScene.js");
        window.game.scene.start("SplashScene");
        document.getElementById("loginBtn").disabled = false;
        console.log('üè† Logout complete - Returned to SplashScene');
      }, 500);
    }
    
    // Show success message
    if (window.showSuccessNotification) {
      showSuccessNotification('üëã Logout Successful - See you next time!');
    }
    
    console.log('‚úÖ Enhanced logout complete');
    
  } catch (error) {
    console.error('‚ùå Logout error:', error);
    
    // Force logout anyway
    showLoginForm();
     
  }
} 
   
// ‚úÖ ADD MISSING UTILITY FUNCTIONS:
function stopPaymentMonitoring() {
  if (paymentCheckInterval) {
    clearInterval(paymentCheckInterval);
    paymentCheckInterval = null;
    console.log('üîÑ Payment monitoring stopped');
  }
}

// mulai co 4.1
  // Cek apakah sudah main minimal 3 ronde (atau sesuai logic kamu)
  //const isGameOver = newScore === 0 && history.hasPlayedBefore && history.totalGamesPlayed >= 3;

  // UPDATE SCORE TEXT DI LEVEL01SCENE//  (format 00000)
  if (window.Phaser && window.game && window.game.scene && window.game.scene.getScene) {
    //const level01 = window.game.scene.getScene("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/Level01Scene.js");
    const level01 = window.game.scene.getScene("Level01Scene");
    if (level01 && level01.scene && level01.scene.isActive && level01.scene.isActive()) {
      if (typeof level01.level01Score !== 'undefined') {
        level01.level01Score = newScore;
      }
      if (level01.scoreText && typeof level01.scoreText.setText === 'function') {
        level01.scoreText.setText(newScore.toString().padStart(5, '0'));
      }
    }
      // Kunci tombol & tampilkan image game over jika level01Score 0 dan pemain lama
     // if (newScore === 0 && history.hasPlayedBefore) {
      if (newScore === 0 &&history.hasPlayedBefore && (history.totalGamesPlayed || 0) >= 3) { // <-- hanya game over jika sudah main 3x
      updatePlayerGameHistory(email, {
      gameOvers: history.gameOvers + 1
      }); 
      //if (isGameOver) {
       setTimeout(() => {
       //const level01 = window.game?.scene?.getScene("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/Level01Scene.js");
       const level01 = window.game.scene.getScene("Level01Scene");
       if (level01) {
        // non aktif playbtn (burem)
        if (level01.playBtn) {
          level01.playBtn.disableInteractive();
          level01.playBtn.setAlpha(0.5);
          console.log('INDEX: PlayBtn diaktifkan di sini', { isPaid, newUser });
        }
        // non aktif 10 puzzle munculkan pesan warning Game Over (sonnet)
        if (level01.lv01Puzzle10Btn) {
          level01.lv01Puzzle10Btn.disableInteractive();
          level01.lv01Puzzle10Btn.setAlpha(0.5);
        }
        // Tampilkan image Game Over Lusi
        if (typeof level01.showGameOverReturnMessage === 'function') {
         level01.showGameOverReturnMessage();
        //} else if (level01.add && level01.textures.exists('gameOver')) {
          //level01.add.image(960, 540, 'gameOver').setDepth(9999).setOrigin(0.5);
        }
      }
      // Tambahan: pastikan Play tetap terkunci
    if (window.lockPlayButton) window.lockPlayButton(); 
    });
  }
  console.log('üìä level01Score updated for', email, newScore);
}
         
// LOCK PLAY & SHOW GAME OVER FUNCTION
window.lockPlayAndShowGameOver = function() {
 // ‚úÖ ADD SAFETY CHECK
  if (!window.game || !window.game.scene || !window.game.scene.getScene) {
    console.warn('‚ö†Ô∏è Game not ready for lockPlayAndShowGameOver');
    return;
  }
    
  setTimeout(() => {
    //const level01 = window.game?.scene?.getScene("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/Level01Scene.js");
    const level01 = window.game.scene.getScene("Level01Scene");
    if (level01) {
      
      if (level01.playBtn) {
        level01.playBtn.disableInteractive();
        level01.playBtn.setAlpha(0.5);
        console.log('INDEX: PlayBtn dinonaktifkan di sini', { isPaid, newUser });
      }
      if (level01.lv01Puzzle10Btn) {
        level01.lv01Puzzle10Btn.disableInteractive();
        level01.lv01Puzzle10Btn.setAlpha(1);
      }
      if (typeof level01.showGameOverReturnMessage === 'function') {
        level01.showGameOverReturnMessage();
      }
    }
   // Tambahan: pastikan Play tetap terkunci
    if (window.lockPlayButton) window.lockPlayButton(); 
  });
}
  

    // ‚úÖ COMPREHENSIVE SAFETY CHECK:
    if (window.Phaser && 
        window.game && 
        window.game.scene && 
        window.game.scene.getScene &&
        typeof window.game.scene.getScene === 'function') {
      
      //const level01 = window.game.scene.getScene("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/Level01Scene.js");
      const level01 = window.game.scene.getScene("Level01Scene");
      if (level01 && 
          level01.scene && 
          level01.scene.isActive &&
          level01.scene.isActive()) {
        
        // ‚úÖ PROPER LOGIC: New, Active, or Paid Users get access
        if (newUser || winUser || lossUser) {
          let userType = 'UNKNOWN';
          if (newUser) userType = 'NEW';
          else if (winUser) userType = 'ACTIVE';
          else if (lossUser) userType = 'LOSS';
          console.log('‚úÖ Unlocking game - User type:', userType);
          
          // === UNLOCK PLAY BUTTON ===
          //if (level01.playBtn) {
            //level01.playBtn.setInteractive();
            //level01.playBtn.setAlpha(1);
          //}
          
          // === UNLOCK 10 PUZZLE BUTTON ===
          if (level01.lv01Puzzle10Btn) {
            level01.lv01Puzzle10Btn.setInteractive();
            level01.lv01Puzzle10Btn.setAlpha(1);
          }


          // ‚úÖ PERBAIKAN - buat async function:
          async function handlePaymentCheck() {
           const email = localStorage.getItem('email');
           if (!email) return;
           // ‚úÖ DEFINISI isPaid SEBELUM DIGUNAKAN (line ~1965)
           const paymentData = await checkPaymentStatusFromBackend(email);
           const isPaid = paymentData && paymentData.isPaid === true;
           // === UNLOCK FAVORITE MENUS (only for paid users) ===
           if (isPaid) {
            // Only unlock favorite music for paid users
            if (level01.musicNotes && Array.isArray(level01.musicNotes)) {
              level01.musicNotes.forEach(note => note.setInteractive({ useHandCursor: true }));  
            }
            if (level01.airBtn) level01.airBtn.setInteractive();
            if (level01.grassContainer && level01.grassContainer.list[0]) {
              level01.grassContainer.list[0].setInteractive({ useHandCursor: true });
              level01.grassContainer.list[0].setAlpha(1);
            }
            if (level01.carrotBtn) level01.carrotBtn.setInteractive();
            if (level01.appleBtn) level01.appleBtn.setInteractive();
          } else {
            // Keep favorite menus interactive for purchase
            if (level01.musicNotes && Array.isArray(level01.musicNotes)) {
              level01.musicNotes.forEach(note => note.setInteractive({ useHandCursor: true }));
            }
            if (level01.airBtn) level01.airBtn.setInteractive();
            if (level01.grassContainer && level01.grassContainer.list[0]) {
              level01.grassContainer.list[0].setInteractive();
              level01.grassContainer.list[0].setAlpha(0.7);
            }
            if (level01.carrotBtn) level01.carrotBtn.setInteractive();
            if (level01.appleBtn) level01.appleBtn.setInteractive();
          }
          
          // === SUCCESS NOTIFICATION ===
          if (window.showSuccessNotification && isPaid) {
            const methodText = method === 'paypal' ? 'PayPal' : 
                             method === 'xsolla' ? 'Xsolla' : 
                             method || 'System';
            showSuccessNotification(`‚úÖ Game Unlocked via ${methodText} - Ready to Play!`);
          }
        } 
          // ‚úÖ PANGGIL FUNCTION  
          handlePaymentCheck();
          
        if (lossUser) {
          console.log('üîí Locking game - Loss user without payment');
  
          // === LOCK PLAY BUTTON ===
          if (level01.playBtn) {
            level01.playBtn.disableInteractive();
            level01.playBtn.setAlpha(0.5);
          }
          
          // === LOCK 10 PUZZLE BUTTON ===
          if (level01.lv01Puzzle10Btn) {
            level01.lv01Puzzle10Btn.disableInteractive();
            level01.lv01Puzzle10Btn.setAlpha(0.5);
          }
          
          // === KEEP FAVORITE MENUS INTERACTIVE (for purchase) ===
          if (level01.musicNotes && Array.isArray(level01.musicNotes)) {
            level01.musicNotes.forEach(note => note.setInteractive({ useHandCursor: true }));
          }
          if (level01.airBtn) level01.airBtn.setInteractive();
          if (level01.grassContainer && level01.grassContainer.list[0]) {
            level01.grassContainer.list[0].setInteractive();
            level01.grassContainer.list[0].setAlpha(0.5);
          }
          if (level01.carrotBtn) level01.carrotBtn.setInteractive();
          if (level01.appleBtn) level01.appleBtn.setInteractive();
          
          // === STOP FAVORITE MUSIC ===
          if (level01.currentFavMusic && level01.currentFavMusic.isPlaying) {
            level01.currentFavMusic.stop();
          }
           // === PLAY MAIN MUSIC ===
          if (level01.mainMusic && !level01.mainMusic.isPlaying) {
            level01.mainMusic.play({ loop: true });
          } else if (level01.mainMusic && level01.mainMusic.isPaused) {
            level01.mainMusic.resume();
          }
          
          console.log('üîí Game locked - Loss user needs to purchase');
        }
      } else {
        console.log(`üéÆ Level01Scene not ready - Payment status: ${isPaid ? 'paid' : 'unpaid'}`);
      }
    } else {
      console.log(`üéÆ Phaser not ready - Payment status: ${isPaid ? 'paid' : 'unpaid'}`);
    }
  }


document.addEventListener('visibilitychange', async () => {
  if (document.visibilityState === 'visible') {
    const email = localStorage.getItem('email');
    if (email) {
      const paymentData = await window.checkPaymentStatusFromBackend(email);
      window.updateGamePaymentStatus(paymentData.isPaid, paymentData.method);
    }
  }
}); 

// ‚úÖ ADD GAME READY CHECK FUNCTION:
function waitForGameReady(callback, maxAttempts = 10) {
  let attempts = 0;
  let completed = false;
  
  const checkReady = () => {
    if (completed) return; // Early exit if already completed
    
    attempts++;
    
    if (window.Phaser && 
        window.game && 
        window.game.scene && 
        window.game.scene.getScene &&
        typeof window.game.scene.getScene === 'function') {

      //const level01 = window.game.scene.getScene("https://backend-paypalblackhorsepuzzle.onrender.com/Scenes/Level01Scene.js");
      const level01 = window.game.scene.getScene("Level01Scene");
      if (level01 && level01.scene && level01.scene.isActive) {
        console.log('‚úÖ Game ready - executing callback');
        completed = true;
        callback();
      } else if (attempts < maxAttempts) {
        console.log(`‚è≥ Waiting for game ready (attempt ${attempts}/${maxAttempts})`);
        setTimeout(checkReady, 500);
      } else {
        console.log('‚ùå Game ready timeout - executing callback anyway');
        completed = true;
        callback();
      }
    } else if (attempts < maxAttempts) {
      console.log(`‚è≥ Waiting for Phaser ready (attempt ${attempts}/${maxAttempts})`);
      setTimeout(checkReady, 500);
    } else {
      console.log('‚ùå Phaser ready timeout - executing callback anyway');
      completed = true;
      callback();
    }
  };
  
  checkReady();
}

// UPDATEGAMESCORE DI HAPUS KARENA DI SPLASHSCENE.JS SUDAH ADA UPDATEUSERPROGRESS

// ‚úÖ SAFE PAYMENT STATUS UPDATE FUNCTION:
function safeUpdatePaymentStatus(email) {
  waitForGameReady(async () => {
    const paymentData = await window.checkPaymentStatusFromBackend(email);
    window.updateGamePaymentStatus(paymentData.isPaid, paymentData.method);
  });
}

// ‚úÖ  ENTER KEY HANDLERS:
document.getElementById('emailInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    if (!loginInProgress) {
      document.getElementById('loginBtn').click();
    }
  }
});

// ‚úÖ ERROR HANDLING & MONITORING:
window.addEventListener('error', (e) => {
  //console.error('üö® Global error caught:', e.error);
  console.error('üî• Global error caught:', e.message || e.error || 'Unknown error', e);
});

window.addEventListener('unhandledrejection', (e) => {
  console.error('üö® Unhandled promise rejection:', e.reason);
});

// ‚úÖ CLEANUP ON PAGE UNLOAD:
window.addEventListener('beforeunload', () => {
  stopPaymentMonitoring();
});

console.log('üöÇ Gerbong kereta enhanced login system ready!');
console.log('‚úÖ Enhanced Black Horse Puzzle system initialized');

// ‚úÖ MISSING MESSAGES & NOTIFICATIONS SYSTEM:
// Function to show login required message
function showLoginRequiredMessage() {
  const message = document.createElement('div');
 
  
  document.body.appendChild(message);
  
  // Auto remove after 5 seconds
  setTimeout(() => {
    if (document.getElementById('login-required-msg')) {
      document.getElementById('login-required-msg').remove();
    }
  }, 5000);
}


// Function to show please wait message
function showPleaseWaitMessage(text = 'Please wait...') {
  // Remove existing wait message
  const existing = document.getElementById('please-wait-msg');
  if (existing) existing.remove();
  
  const message = document.createElement('div');
  message.id = 'please-wait-msg';
  message.style.cssText = `
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    border: 2px solid #00eaff;
    border-radius: 12px;
    padding: 15px 25px;
    color: #00eaff;
    font-size: 16px;
    text-align: center;
    z-index: 10000;
    box-shadow: 0 0 15px #00eaff40;
    font-family: 'Segoe UI', sans-serif;
  `;
  
  message.innerHTML = `
    <div style="margin-bottom: 10px;">‚è≥</div>
    <div>${text}</div>
    <div style="color: #ccc; font-size: 14px; margin-top: 5px;">Please Wait...</div>
  `;
  
  document.body.appendChild(message);
  return message;
}

// Function to hide please wait message
function hidePleaseWaitMessage() {
  const message = document.getElementById('please-wait-msg');
  if (message) {
    message.remove();
  }
}
//============================  =========================


// ‚úÖ DONATION OVERLAY FUNCTION
// This function creates a donation overlay with options to donate via PayPal or Ko-fi

 // ‚úÖ DONATION OVERLAY FUNCTION:
window.showDonation = function() {
  console.log('üéÅ Showing donation overlay...');
  
  // Remove existing donation overlay
  const existing = document.getElementById('donation-overlay');//donation-modal
  if (existing) existing.remove();
  
  // Create donation overlay
  const overlay = document.createElement('div');//const modal ---modal kembalikan ke overlay
  overlay.id = 'donation-overlay';
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    font-family: 'Segoe UI', sans-serif;
  `;
  
  const donationBox = document.createElement('div');
  donationBox.style.cssText = `
    background: rgba(30, 34, 44, 0.95);
    border: 2px solid #00eaff;
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    max-width: 400px;
    box-shadow: 0 0 20px #00eaff60;
  `;
  
  donationBox.innerHTML = `
    <div style="color: #00eaff; font-size: 24px; font-weight: bold; margin-bottom: 20px;">
      üéÅ Support Development
    </div>
    <div style="color: #fff; font-size: 16px; margin-bottom: 20px; line-height: 1.5;">
      Help us create more amazing puzzles!<br>
      Your support means everything to us.<br><br>
      <span style="color: #ccc;">Bantu kami membuat puzzle yang lebih menakjubkan!</span>
    </div>
    <div style="margin-bottom: 20px;">
      <button onclick="window.open('https://paypal.me/arselco')" 
              style="background: #0070ba; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px;">
        üí≥ PayPal
      </button>
      <button id="kofi-donate-btn" 
              style="background: #ff5722; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px;">
        ‚òï Ko-fi
      </button>
    </div>
    <button id="close-donation-btn" 
            style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
      Close
    </button>
  `;

  overlay.appendChild(donationBox);
  document.body.appendChild(overlay);

  // Tombol close hanya menutup panel
  document.getElementById('close-donation-btn').onclick = function() {
    overlay.remove();
  };

  // Tombol PayPal redirect ke PayPal.me
  //document.getElementById('paypal-donate-btn').onclick = function() {
    //window.open('https://paypal.me/arselco', '_blank');
  //};

  // Pastikan id di HTML: <button id="paypal-donate-btn" ...>
const paypalBtn = document.getElementById('paypal-donate-btn');
if (paypalBtn) {
  paypalBtn.onclick = function() {
    window.open('https://paypal.me/arselco', '_blank');
  };
}


  // Tombol Ko-fi tampilkan pesan proses
  document.getElementById('kofi-donate-btn').onclick = function() {
    overlay.remove();
    showSuccessNotification('Payment with Ko-fi is in process. Please wait for the next update!');
  };

  // Close on outside click
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.remove();
    }
  });
  
  console.log('‚úÖ Donation overlay displayed');
};


// batas donation

// Function to show success notification
function showSuccessNotification(text) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed; top: 20px; right: 20px;
    background: rgba(0, 200, 0, 0.9);
    color: white; padding: 12px 18px;
    border-radius: 8px; z-index: 99999;
    font-size: 14px; font-weight: bold;
    box-shadow: 0 4px 12px rgba(0, 200, 0, 0.3);
    transform: translateX(100%);
    transition: transform 0.3s ease;
  `;
  notification.textContent = text;
  document.body.appendChild(notification);
  
  // Slide in
  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
  }, 100);
  
  // Auto remove
  setTimeout(() => {
    notification.style.transform = 'translateX(100%)';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Function to show error notification
function showErrorNotification(text) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed; top: 50px; right: 30px;
    background: rgba(200, 0, 0, 0.9);
    color: white; padding: 12px 18px;
    border-radius: 8px; z-index: 9999;
    font-size: 14px; font-weight: bold;
    box-shadow: 0 4px 12px rgba(200, 0, 0, 0.3);
    transform: translateX(100%);
    transition: transform 0.3s ease;
  `;
  notification.textContent = text;
  document.body.appendChild(notification);
  
  // Slide in
  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
  }, 100);
  
  // Auto remove
  setTimeout(() => {
    notification.style.transform = 'translateX(100%)';
    setTimeout(() => notification.remove(), 300);
  }, 4000);
}

// Function to check game access and show appropriate message
function checkGameAccess() {
  const email = localStorage.getItem("email");
  
  if (!email) {
    // No login - show login required message
    showLoginRequiredMessage();
    return false;
  }
  
  // Check payment status
  const urlParams = new URLSearchParams(window.location.search);
  const hasPaid = urlParams.get('paid') === '1';
  const hasPaypalPayment = urlParams.get('paypal_paid') === '1' || 
                           urlParams.get('paypal_success') === 'true';  
  
  if (!hasPaid) {
    // No payment - show payment required message  
    showPaymentRequiredMessage();
    return false;
  }
  
  return true;
}

// Function to show payment required message
function showPaymentRequiredMessage() {
  // ‚úÖ CHECK IF GAME IS ACTUALLY OVER:
  const email = localStorage.getItem("email");
  
  if (email) {
    const isGameOver = localStorage.getItem(`gameOver_${email}`) === 'true';
    if (!isGameOver) {
      console.log('üéÆ Game not over yet - message blocked');
      return;
    }
  }
   // ‚úÖ CHECK IF PAYMENT ALREADY MADE:
  const urlParams = new URLSearchParams(window.location.search);
  const hasPaid = urlParams.get('paid') === '1' || 
                     urlParams.get('paypal_paid') === '1' || 
                     urlParams.get('paypal_success') === 'true';
  
  if (hasPaid) {
    console.log('üí≥ Payment already made - message blocked');
    return;
  }
    console.log('üíÄ Game over + No payment - showing purchase message');

  // ‚úÖ CREATE MESSAGE: isinya di hapus ada di notepad
  const message = document.createElement('div');
 
  
  document.body.appendChild(message);
  
  // Auto remove after 5 seconds
  setTimeout(() => {
    if (document.getElementById('payment-required-msg')) {
      document.getElementById('payment-required-msg').remove();
    }
  }, 2000);
};

// ‚úÖ GLOBAL ACCESS TO FUNCTIONS:
window.checkGameAccess = checkGameAccess;
window.showLoginRequiredMessage = showLoginRequiredMessage;
window.showPaymentRequiredMessage = showPaymentRequiredMessage;
window.showPleaseWaitMessage = showPleaseWaitMessage;
window.hidePleaseWaitMessage = hidePleaseWaitMessage;
window.showSuccessNotification = showSuccessNotification;
window.showErrorNotification = showErrorNotification;


// ‚úÖ AUTO-SYNC FUNCTION: Sinkronisasi progress ke backend setiap 1 menit
window._autoSyncIntervalId = null;
window.startAutoSync = function(email) {
  if (window._autoSyncIntervalId) {
    clearInterval(window._autoSyncIntervalId);
  }
  if (!email) return;
  window._autoSyncIntervalId = setInterval(async function() {
    try {
      console.log('üîÑ [AutoSync] Syncing progress to backend...');
      await syncProgressFromBackend(email);
    } catch (err) {
      console.error('‚ùå [AutoSync] Failed to sync:', err);
    }
  }, 60000); // 1 menit
  console.log('‚úÖ [AutoSync] Started auto-sync every 1 minute for', email);
};

console.log('‚úÖ Enhanced notification system initialized');
console.log('üîî All user feedback messages ready!');

</script>
</body>
</html>